// SharpSend Waitlist - Cloudflare Worker
// Secure ConvertKit integration with enterprise-grade security

// Configuration
const CONVERTKIT_CONFIG = {
  apiKey: 'yltKh4MLg9kI1yzNMdABUQ',
  formId: '8480235',
  baseUrl: 'https://api.convertkit.com/v3'
};

// CORS configuration - only allow your domain
const CORS_HEADERS = {
  'Access-Control-Allow-Origin': 'https://sharpsend.io',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type',
  'Access-Control-Max-Age': '86400',
};

// Rate limiting - prevent abuse
const RATE_LIMIT = {
  maxRequests: 10, // Max 10 requests per IP per minute
  windowMs: 60000  // 1 minute window
};

// Simple in-memory rate limiting
const rateLimitStore = new Map();

// Helper Functions
function extractFirstNameFromEmail(email) {
  const username = email.split('@')[0];
  const name = username.split(/[._-]/)[0];
  return name.charAt(0).toUpperCase() + name.slice(1);
}

function calculateLeadScore(formData) {
  let score = 50; // Base score
  
  // Score based on subscriber count
  const subscriberCountScores = {
    'Under 1,000': 10,
    '1,000 - 5,000': 20,
    '5,000 - 25,000': 40,
    '25,000 - 100,000': 70,
    'Over 100,000': 100
  };
  
  score += subscriberCountScores[formData.subscriberCount] || 0;
  
  // Score based on email platform
  const platformScores = {
    'Mailchimp': 20,
    'SendGrid': 30,
    'ConvertKit': 35,
    'ActiveCampaign': 40,
    'Other': 15
  };
  
  score += platformScores[formData.emailPlatform] || 0;
  
  // Score based on company name
  if (formData.company && formData.company.length > 3) {
    score += 20;
  }
  
  return Math.min(score, 100);
}

function generateAllTags(formData) {
  const tags = [
    'sharpsend-waitlist',
    'source-website',
    'financial-publisher'
  ];

  // Subscriber count tags
  const subscriberTags = {
    'Under 1,000': ['subscribers-under-1k', 'business-micro'],
    '1,000 - 5,000': ['subscribers-1k-5k', 'business-small'],
    '5,000 - 25,000': ['subscribers-5k-25k', 'business-medium'],
    '25,000 - 100,000': ['subscribers-25k-100k', 'business-large'],
    'Over 100,000': ['subscribers-over-100k', 'business-enterprise']
  };

  if (formData.subscriberCount && subscriberTags[formData.subscriberCount]) {
    tags.push(...subscriberTags[formData.subscriberCount]);
  }

  // Platform tags
  const platformTags = {
    'Mailchimp': ['platform-mailchimp', 'intent-beginner'],
    'SendGrid': ['platform-sendgrid', 'intent-intermediate'],
    'ConvertKit': ['platform-convertkit', 'intent-intermediate'],
    'ActiveCampaign': ['platform-activecampaign', 'intent-advanced'],
    'Other': ['platform-other', 'intent-beginner']
  };

  if (formData.emailPlatform && platformTags[formData.emailPlatform]) {
    tags.push(...platformTags[formData.emailPlatform]);
  }

  // Priority tags based on lead score
  const leadScore = calculateLeadScore(formData);
  if (leadScore >= 80) {
    tags.push('priority-high');
  } else if (leadScore >= 60) {
    tags.push('priority-medium');
  } else {
    tags.push('priority-low');
  }

  // Timing tags
  const now = new Date();
  const hour = now.getHours();
  if (hour >= 9 && hour <= 17) {
    tags.push('signup-business-hours');
  } else {
    tags.push('signup-after-hours');
  }

  return tags;
}

// Rate limiting check
function checkRateLimit(ip) {
  const now = Date.now();
  const key = `${ip}:${Math.floor(now / RATE_LIMIT.windowMs)}`;
  
  const current = rateLimitStore.get(key) || 0;
  
  if (current >= RATE_LIMIT.maxRequests) {
    return false;
  }
  
  rateLimitStore.set(key, current + 1);
  
  // Clean up old entries
  for (const [storeKey] of rateLimitStore) {
    const keyTime = parseInt(storeKey.split(':')[1]);
    if (keyTime < Math.floor(now / RATE_LIMIT.windowMs) - 1) {
      rateLimitStore.delete(storeKey);
    }
  }
  
  return true;
}

// Validation
function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function validateFormData(data) {
  const errors = [];
  
  if (!data.email) errors.push('Email is required');
  if (!data.company) errors.push('Company is required');
  if (!data.subscriberCount) errors.push('Subscriber count is required');
  if (!data.emailPlatform) errors.push('Email platform is required');
  
  if (data.email && !validateEmail(data.email)) {
    errors.push('Invalid email format');
  }
  
  const validSubscriberCounts = [
    'Under 1,000',
    '1,000 - 5,000',
    '5,000 - 25,000',
    '25,000 - 100,000',
    'Over 100,000'
  ];
  
  if (data.subscriberCount && !validSubscriberCounts.includes(data.subscriberCount)) {
    errors.push('Invalid subscriber count option');
  }
  
  const validPlatforms = ['Mailchimp', 'SendGrid', 'ConvertKit', 'ActiveCampaign', 'Other'];
  
  if (data.emailPlatform && !validPlatforms.includes(data.emailPlatform)) {
    errors.push('Invalid email platform option');
  }
  
  if (data.company && data.company.length > 100) {
    errors.push('Company name too long (max 100 characters)');
  }
  
  return errors;
}

// Main subscription function
async function subscribeToWaitlist(formData, clientIP) {
  try {
    const leadScore = calculateLeadScore(formData);
    const allTags = generateAllTags(formData);
    
    const subscriptionData = {
      api_key: CONVERTKIT_CONFIG.apiKey,
      email: formData.email,
      first_name: extractFirstNameFromEmail(formData.email),
      fields: {
        company: formData.company,
        subscriber_count: formData.subscriberCount,
        current_platform: formData.emailPlatform,
        signup_source: 'sharpsend_website',
        lead_score: leadScore,
        signup_date: new Date().toISOString(),
        client_ip: clientIP
      },
      tags: allTags
    };
    
    const response = await fetch(`${CONVERTKIT_CONFIG.baseUrl}/forms/${CONVERTKIT_CONFIG.formId}/subscribe`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(subscriptionData)
    });

    const result = await response.json();
    
    if (response.ok && result.subscription) {
      return {
        success: true,
        subscriberId: result.subscription.subscriber.id,
        leadScore: leadScore,
        tags: allTags.length,
        message: 'Successfully joined waitlist!'
      };
    } else {
      throw new Error(result.message || 'Subscription failed');
    }
  } catch (error) {
    throw error;
  }
}

// Main Worker Export
export default {
  async fetch(request, env, ctx) {
    const clientIP = request.headers.get('CF-Connecting-IP') || 'unknown';
    
    // Handle CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        status: 200,
        headers: CORS_HEADERS
      });
    }
    
    // Only allow POST requests
    if (request.method !== 'POST') {
      return new Response(JSON.stringify({
        success: false,
        error: 'Method not allowed'
      }), {
        status: 405,
        headers: {
          'Content-Type': 'application/json',
          ...CORS_HEADERS
        }
      });
    }
    
    try {
      // Rate limiting
      if (!checkRateLimit(clientIP)) {
        return new Response(JSON.stringify({
          success: false,
          error: 'Rate limit exceeded. Please try again later.'
        }), {
          status: 429,
          headers: {
            'Content-Type': 'application/json',
            ...CORS_HEADERS
          }
        });
      }
      
      // Parse request body
      const formData = await request.json();
      
      // Validate form data
      const validationErrors = validateFormData(formData);
      if (validationErrors.length > 0) {
        return new Response(JSON.stringify({
          success: false,
          error: 'Validation failed',
          details: validationErrors
        }), {
          status: 400,
          headers: {
            'Content-Type': 'application/json',
            ...CORS_HEADERS
          }
        });
      }
      
      // Subscribe to waitlist
      const result = await subscribeToWaitlist(formData, clientIP);
      
      // Log successful subscription
      console.log('✅ Subscription successful:', {
        email: formData.email,
        subscriberId: result.subscriberId,
        leadScore: result.leadScore,
        tags: result.tags,
        clientIP: clientIP,
        timestamp: new Date().toISOString()
      });
      
      return new Response(JSON.stringify(result), {
        status: 200,
        headers: {
          'Content-Type': 'application/json',
          ...CORS_HEADERS
        }
      });
      
    } catch (error) {
      console.error('❌ Worker error:', error);
      
      return new Response(JSON.stringify({
        success: false,
        error: 'Internal server error',
        message: 'Please try again later'
      }), {
        status: 500,
        headers: {
          'Content-Type': 'application/json',
          ...CORS_HEADERS
        }
      });
    }
  }
};

